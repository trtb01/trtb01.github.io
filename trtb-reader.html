<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZERO_READER_STRICT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --c-bg: #000000;
            --c-text: #FFFFFF;
            --c-accent: #FF0000;
            --f-mono: 'Courier New', Courier, monospace;
            --f-size: 15px; /* Fixed size for calculation */
            --header-h: 40px;
            --footer-h: 30px;
            --border: 2px solid var(--c-accent);
        }
        
        body.light-theme { --c-bg: #FFFFFF; --c-text: #000000; }

        /* --- RESET & GEOMETRY --- */
        * { box-sizing: border-box; border-radius: 0px !important; }
        
        body, html {
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            background-color: var(--c-bg);
            color: var(--c-text);
            font-family: var(--f-mono);
            font-size: var(--f-size);
            overflow: hidden; /* Prevent body scroll */
        }

        /* --- LAYOUT GRID --- */
        #app {
            display: grid;
            grid-template-rows: var(--header-h) 1fr var(--footer-h);
            height: 100%; width: 100%;
        }

        /* --- HEADER --- */
        header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; border-bottom: var(--border);
            z-index: 10; background: var(--c-bg);
        }
        #book-title {
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            max-width: 200px; font-weight: bold;
        }
        button {
            background: var(--c-bg); color: var(--c-text);
            border: var(--border); font-family: var(--f-mono);
            cursor: pointer; padding: 4px 8px;
        }
        button:hover { background: var(--c-accent); color: var(--c-bg); }
        .btn-circle { border-radius: 50% !important; width: 26px; height: 26px; padding: 0; }

        /* --- MAIN STAGE (Center the Page) --- */
        #stage {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            width: 100%; height: 100%;
        }

        /* --- THE STRICT PAGE CONTAINER --- */
        #page-view {
            /* Width/Height set by JS based on Char Count */
            border: var(--border); /* The Red Outline requested */
            overflow: hidden; /* Mask other pages */
            position: relative;
            background: var(--c-bg);
        }

        /* --- SCROLLING CONTENT LAYER --- */
        #content-scroll {
            height: 100%;
            /* Column logic applied via JS for precision */
            column-gap: 0px; 
            column-fill: auto;
            position: absolute;
            top: 0; left: 0;
            
            /* Typography */
            line-height: 1.5;
            text-align: justify;
        }

        /* Content Styling */
        #content-scroll p { margin-bottom: 1em; text-indent: 1em; }
        #content-scroll h1, h2 { border-bottom: 1px solid red; break-after: avoid; }
        
        /* Highlight Span */
        .highlight { border-top: 2px solid red; color: red; }

        /* --- CLICK ZONES (Invisible Navigation) --- */
        .click-zone {
            position: absolute; top: 0; bottom: 0; width: 100px; z-index: 5;
            cursor: pointer;
        }
        #zone-left { left: 0; }
        #zone-right { right: 0; }

        /* --- FOOTER --- */
        footer {
            border-top: var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; font-size: 12px;
            z-index: 10; background: var(--c-bg);
        }

        /* --- UTILITY PANELS (Hidden by default) --- */
        .panel {
            position: absolute; background: var(--c-bg); border: var(--border);
            padding: 10px; z-index: 20; display: none;
        }
        .panel.open { display: flex; flex-direction: column; gap: 10px; }
        
        #panel-util { top: 40px; left: 0; width: 100%; border-left:0; border-right:0; }
        #panel-nav { top: 0; left: 0; bottom: 0; width: 250px; padding-top: 50px; }
        #panel-note { bottom: 30px; left: 0; width: 100%; height: 150px; }
        textarea { width: 100%; height: 80px; background: var(--c-bg); color: var(--c-text); border: var(--border); }

        /* Measurement element */
        #measure-char { visibility: hidden; position: absolute; white-space: nowrap; }

    </style>
</head>
<body>

    <div id="app">
        <header>
            <button onclick="toggle('panel-util')">SET</button>
            <span id="book-title">NO BOOK</span>
            <button class="btn-circle" onclick="toggle('panel-nav')">N</button>
        </header>

        <div id="stage">
            <div id="zone-left" class="click-zone" onclick="turn(-1)"></div>
            <div id="zone-right" class="click-zone" onclick="turn(1)"></div>

            <div id="page-view">
                <div id="content-scroll"></div>
            </div>
        </div>

        <footer>
            <span id="page-num">0/0</span>
            <button onclick="toggle('panel-note')">NOTE</button>
        </footer>

        <div id="panel-util" class="panel">
            <input type="file" id="file-in">
            <div>
                <button onclick="setTheme('dark')">BLK</button>
                <button onclick="setTheme('light')">WHT</button>
            </div>
        </div>
        
        <div id="panel-nav" class="panel">
            <strong>CHAPTERS</strong>
            <div id="toc-list"></div>
        </div>

        <div id="panel-note" class="panel">
            <label>NOTE:</label>
            <textarea id="note-txt"></textarea>
            <button onclick="saveNote()">SAVE</button>
        </div>
    </div>

    <span id="measure-char">X</span>

    <script>
        /* --- STATE --- */
        let state = {
            rawText: "",
            ftype: "",
            pageIndex: 0,
            totalPages: 0,
            
            // Geometry
            charW: 0,
            viewW: 0, 
            viewH: 0
        };

        const dom = {
            view: document.getElementById('page-view'),
            content: document.getElementById('content-scroll'),
            measure: document.getElementById('measure-char'),
            stage: document.getElementById('stage'),
            pgNum: document.getElementById('page-num')
        };

        /* --- GEOMETRY ENGINE --- */
        function calculateGeometry() {
            // 1. Measure 1 Char Width
            dom.measure.textContent = "X";
            const rect = dom.measure.getBoundingClientRect();
            state.charW = rect.width;

            // 2. Measure Available Stage Space
            const stageRect = dom.stage.getBoundingClientRect();
            const availW = stageRect.width - 40; // 20px margin each side
            const availH = stageRect.height - 40; // 20px margin top/bot

            // 3. Calculate Exact Characters that fit
            const charsAcross = Math.floor(availW / state.charW);
            
            // 4. Set Viewport to EXACT pixel multiple of chars
            state.viewW = charsAcross * state.charW;
            state.viewH = availH;

            // 5. Apply Dimensions to the "Specific Div"
            dom.view.style.width = state.viewW + "px";
            dom.view.style.height = state.viewH + "px";
            
            // 6. Apply Column Logic to Inner Content
            // IMPORTANT: column-width must match viewW exactly. Gap must be 0.
            dom.content.style.columnWidth = state.viewW + "px";
            dom.content.style.columnGap = "0px";
            dom.content.style.width = "auto"; // Let it expand infinitely right
            dom.content.style.height = state.viewH + "px";

            updatePagePosition();
        }

        /* --- PAGINATION --- */
        function updatePagePosition() {
            // Translate the long scroll by exactly one view width per page
            const offset = -(state.pageIndex * state.viewW);
            dom.content.style.transform = `translateX(${offset}px)`;
            
            // Calculate Total Pages
            // We measure the full scroll width of the content
            const totalScroll = dom.content.scrollWidth;
            state.totalPages = Math.ceil(totalScroll / state.viewW);
            
            dom.pgNum.textContent = `PAGE ${state.pageIndex + 1} / ${state.totalPages || 1}`;
        }

        function turn(dir) {
            const next = state.pageIndex + dir;
            if(next >= 0 && next < state.totalPages) {
                state.pageIndex = next;
                updatePagePosition();
            }
        }

        // Handle Window Resize
        window.onresize = () => {
            calculateGeometry();
            // Re-render text to reflow columns
            if(state.rawText) render(); 
        };

        /* --- FILE IO --- */
        document.getElementById('file-in').addEventListener('change', e => {
            const f = e.target.files[0];
            if(!f) return;
            
            document.getElementById('book-title').textContent = f.name;
            state.pageIndex = 0;
            const ext = f.name.split('.').pop();

            if(ext === 'epub') {
                alert("EPUB not supported in 'Strict Geometry' mode yet. Please convert to TXT/MD for best results.");
                return;
            }

            const r = new FileReader();
            r.onload = (evt) => {
                state.rawText = evt.target.result;
                state.ftype = ext;
                render();
                toggle('panel-util');
            };
            r.readAsText(f);
        });

        function render() {
            calculateGeometry(); // Ensure sizing is fresh
            
            let html = state.rawText;
            if(state.ftype === 'md') html = marked.parse(html);
            else html = html.replace(/\n/g, '<br>');

            dom.content.innerHTML = html;
            
            // Wait for DOM to flow text into columns, then calc pages
            setTimeout(updatePagePosition, 100);
        }

        /* --- UI UTILS --- */
        function toggle(id) {
            const el = document.getElementById(id);
            const open = el.classList.contains('open');
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('open'));
            if(!open) el.classList.add('open');
        }

        function setTheme(t) {
            if(t==='light') document.body.classList.add('light-theme');
            else document.body.classList.remove('light-theme');
        }
        
        // Keyboard Support
        document.addEventListener('keydown', e => {
            if(e.key === 'ArrowRight') turn(1);
            if(e.key === 'ArrowLeft') turn(-1);
        });

        // Initial Geometry Check
        calculateGeometry();

    </script>
</body>
</html>
