<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRTB AUDIO PROTOCOL</title>
    <style>
        /*
         * TRTB.css (Thor's Radical Technical Brutalism)
         * Version: 1.0.1
         * Author: Thor Smith
         * Philosophy: Modular, 2D, High-Contrast, Minimalist.
         */

        :root {
            /* Color Palette */
            --bg: #000000;
            --fg: #ffffff;
            --accent: #ff0000;

            /* Borders & Outlines */
            --border-sm: 2px;
            --border-md: 5px;
            --border-lg: 10px;

            /* Spacing */
            --pad-inner: 5px;
            --indent: 10px;
            
            /* Typography */
            --font-main: monospace;
            --base-scale: 0.85;
        }

        /* Theme Switch: Light Mode Overrides */
        [data-theme="light"] {
            --bg: #ffffff;
            --fg: #000000;
        }

        /* Global Reset */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            border-radius: 0 !important;
            font-family: var(--font-main);
            font-size: calc(1rem * var(--base-scale));
        }

        body {
            background-color: var(--bg);
            color: var(--fg);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 40px 20px;
            overflow: hidden;
        }

        /* --- Layout Structure --- */
        #trtb_title { position: absolute; top: 10px; left: 20px; text-transform: uppercase; font-weight: bold; }
        #trtb_meta_top { position: absolute; top: 10px; right: 20px; display: flex; gap: 10px; }
        
        #app_container {
            border: var(--border-lg) solid var(--accent);
            width: 100%;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 10px;
        }

        #trtb_footer { padding-top: 10px; width: 100%; display: flex; justify-content: space-between; }

        /* --- Modular Div Logic --- */
        .trtb_module {
            width: 100%;
            margin: 0 0 20px 0;
            border: var(--border-md) solid var(--accent);
            padding: var(--pad-inner);
            background: var(--bg);
            position: relative;
        }

        /* --- Components --- */
        h2 { background: var(--accent); color: #000; padding: 2px 5px; display: inline-block; width: 100%; margin-bottom: 10px; }
        
        button {
            background: var(--bg); color: var(--fg);
            border: var(--border-sm) solid var(--accent);
            padding: 5px 10px; cursor: pointer; margin: 2px;
            text-transform: uppercase; font-weight: bold;
        }
        button:hover { background: var(--accent); color: var(--bg); }

        input[type="text"], input[type="file"] {
            background: var(--bg); color: var(--fg);
            border: var(--border-sm) solid var(--accent);
            outline: var(--border-sm) solid var(--accent);
            outline-offset: 2px; margin: 10px; padding: 5px; width: calc(100% - 20px);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #000; border-left: 2px solid var(--accent); }
        ::-webkit-scrollbar-thumb { background: #000; border: 2px solid var(--accent); }
        ::-webkit-scrollbar-thumb:hover { background: #fff; }
    </style>
</head>
<body>

    <div id="trtb_title">TRTB_AUDIO_UNIT</div>
    <div id="trtb_meta_top">
        <button onclick="const c=document.documentElement.getAttribute('data-theme');document.documentElement.setAttribute('data-theme',c==='light'?'dark':'light');">L/D_MODE</button>
        <span>SYS_RDY</span>
    </div>

    <div id="app_container">

        <div id="trtb_music_player" class="trtb_module" style="display: flex; flex-direction: column; height: 100%; border: none; padding: 0;">
            
            <div id="player_header" style="border-bottom: var(--border-md) solid var(--accent); padding: 10px;">
                <button id="btn_open_loader" style="width: 100%;">[+] LOAD_MEDIA_SOURCE</button>
                <div id="loader_panel" style="display: none; border-top: var(--border-sm) solid var(--accent); margin-top: 10px; padding-top: 10px;">
                    <p style="text-indent: 10px; margin-bottom:5px;">SOURCE_SELECT:</p>
                    <input type="file" id="file_input" accept=".mp3,.flac,.wav">
                    <p style="text-indent: 10px; margin-bottom:5px;">OR_WEB_STREAM:</p>
                    <input type="text" id="url_input" placeholder="HTTPS://REMOTE_RESOURCE...">
                    <button id="btn_activate_source" style="width: 100%; margin-top: 10px;">>> INITIALIZE_DATA_STREAM</button>
                </div>
            </div>

            <div id="player_body" style="flex-grow: 1; display: flex; overflow: hidden;">
                <div id="viz_area" style="flex-grow: 1; position: relative; display: flex; align-items: flex-end; justify-content: center;">
                    <canvas id="viz_canvas" style="width: 100%; height: 100%;"></canvas>
                    <div style="position: absolute; top: 10px; left: 10px; font-size: 0.7rem; color: var(--accent);">FREQ_MONITOR::ACTIVE</div>
                </div>
                <div id="title_sidebar" style="width: 50px; border-left: var(--border-md) solid var(--accent); display: flex; align-items: center; justify-content: center; background: var(--bg);">
                    <h2 id="track_title_display" style="writing-mode: vertical-rl; text-orientation: mixed; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-height: 90%; background: transparent; color: var(--fg); padding: 0;">NO_MEDIA_LOADED</h2>
                </div>
            </div>

            <div id="player_controls" style="border-top: var(--border-md) solid var(--accent); padding: 15px; display: flex; justify-content: space-between;">
                <button id="btn_play_pause" style="flex-grow: 2; height: 50px; font-size: 1.2rem;">[PLAY]</button>
                <div style="width: 10px;"></div>
                <button id="btn_repeat" style="flex-grow: 1; height: 50px;">RPT:OFF</button>
            </div>

            <audio id="audio_core" crossorigin="anonymous"></audio>

            <script>
                (function() {
                    // Scope identifiers to this block to ensure portability
                    const audio = document.getElementById('audio_core');
                    const btnLoader = document.getElementById('btn_open_loader');
                    const panel = document.getElementById('loader_panel');
                    const fInput = document.getElementById('file_input');
                    const uInput = document.getElementById('url_input');
                    const btnActivate = document.getElementById('btn_activate_source');
                    const btnPlay = document.getElementById('btn_play_pause');
                    const btnRepeat = document.getElementById('btn_repeat');
                    const titleDisp = document.getElementById('track_title_display');
                    const canvas = document.getElementById('viz_canvas');
                    const ctx = canvas.getContext('2d');
                    
                    let audioCtx, analyzer, srcNode, isInit = false;

                    // UI Handlers
                    btnLoader.onclick = () => {
                        const isHidden = panel.style.display === 'none';
                        panel.style.display = isHidden ? 'block' : 'none';
                        btnLoader.innerText = isHidden ? '[-] CLOSE_PANEL' : '[+] LOAD_MEDIA_SOURCE';
                    };

                    btnActivate.onclick = () => {
                        if (fInput.files.length) {
                            const file = fInput.files[0];
                            audio.src = URL.createObjectURL(file);
                            titleDisp.innerText = file.name.toUpperCase();
                        } else if (uInput.value.trim()) {
                            audio.src = uInput.value.trim();
                            titleDisp.innerText = "WEB_STREAM_DATA";
                        } else { return; }

                        initAudio();
                        audio.play().catch(e=>console.log(e));
                        panel.style.display = 'none';
                        btnLoader.innerText = '[+] LOAD_MEDIA_SOURCE';
                        updatePlayBtn();
                    };

                    btnPlay.onclick = () => {
                        if(!isInit) initAudio();
                        audio.paused ? audio.play() : audio.pause();
                        updatePlayBtn();
                    };

                    btnRepeat.onclick = () => {
                        audio.loop = !audio.loop;
                        btnRepeat.innerText = audio.loop ? "RPT:ON" : "RPT:OFF";
                        const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
                        const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim();
                        
                        // Strict style swapping
                        if(audio.loop) {
                            btnRepeat.style.backgroundColor = "var(--accent)";
                            btnRepeat.style.color = "var(--bg)";
                        } else {
                            btnRepeat.style.backgroundColor = "var(--bg)";
                            btnRepeat.style.color = "var(--fg)";
                        }
                    };

                    // Events
                    audio.onplay = updatePlayBtn;
                    audio.onpause = updatePlayBtn;
                    
                    function updatePlayBtn() { 
                        btnPlay.innerText = audio.paused ? "[PLAY]" : "[PAUSE]"; 
                    }

                    // Visualization
                    function initAudio() {
                        if(isInit) return;
                        try {
                            const AudCtx = window.AudioContext || window.webkitAudioContext;
                            audioCtx = new AudCtx();
                            analyzer = audioCtx.createAnalyser();
                            srcNode = audioCtx.createMediaElementSource(audio);
                            srcNode.connect(analyzer);
                            analyzer.connect(audioCtx.destination);
                            analyzer.fftSize = 64; 
                            isInit = true;
                            render();
                        } catch(e) { console.log(e); }
                    }

                    function render() {
                        requestAnimationFrame(render);
                        // Dynamic resizing based on parent container
                        canvas.width = canvas.parentElement.clientWidth;
                        canvas.height = canvas.parentElement.clientHeight;
                        
                        // Clear
                        const style = getComputedStyle(document.body);
                        ctx.fillStyle = style.getPropertyValue('--bg');
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        if(!isInit) return;

                        const buffer = analyzer.frequencyBinCount;
                        const data = new Uint8Array(buffer);
                        analyzer.getByteFrequencyData(data);
                        
                        const barW = (canvas.width / buffer) * 2;
                        let x = 0;
                        
                        ctx.fillStyle = style.getPropertyValue('--accent');
                        
                        for(let i=0; i < buffer; i++) {
                            const h = (data[i] / 255) * canvas.height;
                            ctx.fillRect(x, canvas.height - h, barW, h);
                            x += barW + 2;
                        }
                    }
                })();
            </script>
        </div>
        </div>

    <div id="trtb_footer">
        <span>MODE: LOCAL_EXECUTION</span>
        <span>&copy; 2025 Thor Smith</span>
    </div>

</body>
</html>
