<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>encry-offline.html</title>
    <style>
        /* ========================================= */
        /* EMBEDDED TRTB.CSS               */
        /* ========================================= */
        
        /* --- CSS Variables --- */
        :root {
            --line-thick: 1px;       /* Global variable for line thickness */
            --page-paddi: 5%;        /* Padding around the entire page */
            --min-gap: 5px;          /* Minimal padding for content inside borders */
            --tight-line: 1.0;       /* Very tight vertical spacing for text */
            --font-size0: 16px;      /* Base font size for all text (added a 0 to make 10 chars) */
            --indentatio: 3rem;      /* Equivalent to ~0.5 inches (3 * 16px = 48px) */
            --slim-v-mar: 0.5%;      /* Very very slim vertical margins for blocks */
            --hr-v-margi: 2%;        /* Slightly more visible margin for HR */
            --para-inden: 2ch;       /* First line of paragraph indented 2 characters */
            --head-inden: 4ch;       /* Headers indented 4 characters */
        }

        /* --- General Styling --- */
        body {
            background-color: black;
            color: white;
            font-family: monospace;
            font-size: var(--font-size0);
            line-height: var(--tight-line);
            margin: 0;
            padding: var(--page-paddi);
            box-sizing: border-box;
        }

        /* --- Paragraphs --- */
        p {
            margin: var(--slim-v-mar) 0;
            text-indent: var(--para-inden);
        }

        /* --- Headers --- */
        h1, h2, h3, h4, h5, h6 {
            background-color: red;
            color: black;
            font-size: inherit;
            margin-top: 0;
            margin-bottom: 0;
            margin-left: var(--head-inden);
            padding: 5px 10px;
            display: inline-block;
            line-height: var(--tight-line);
        }

        /* --- Links --- */
        a {
            color: white;
            text-decoration: none;
            text-decoration-line: overline;
            text-decoration-color: red;
            text-decoration-thickness: var(--line-thick);
            padding: 2px 4px;
            transition: background-color 0.1s ease-in-out, color 0.1s ease-in-out;
        }

        a:hover {
            background-color: white;
            color: black;
        }

        /* --- Emphasis (.em class) --- */
        .em {
            color: red;
        }

        /* --- Code Blocks (pre, code) --- */
        pre, code {
            background-color: black;
            color: white;
            border: var(--line-thick) solid white;
            padding: var(--min-gap);
            margin: var(--slim-v-mar) 0;
            display: block;
            overflow-x: auto;
            box-sizing: border-box;
            font-size: var(--font-size0);
            line-height: var(--tight-line);
        }

        /* Inline code (e.g., `code` tag not inside `pre`) */
        :not(pre) > code {
            border-top: none;
            border-bottom: none;
            border-left: var(--line-thick) solid white;
            border-right: var(--line-thick) solid white;
            padding-top: 0;
            padding-bottom: 0;
            padding-left: 3px;
            padding-right: 3px;
            display: inline-block;
            vertical-align: middle;
            line-height: inherit;
        }

        /* --- Lists --- */
        ul, ol {
            list-style: none;
            padding-left: 0;
            border-left: none;
            margin: var(--slim-v-mar) 0;
        }

        ul li::before {
            content: 'â€¢';
            color: red;
            display: inline-block;
            width: 1em;
            margin-right: 0.5em;
        }

        ol {
            counter-reset: list-item;
        }
        ol li::before {
            counter-increment: list-item;
            content: counter(list-item) ". ";
            color: red;
            display: inline-block;
            width: 2em;
            margin-right: 0.5em;
            text-align: right;
        }

        /* --- Tables --- */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: var(--slim-v-mar) 0;
            font-size: var(--font-size0);
        }

        th, td {
            border: var(--line-thick) solid red;
            padding: 8px;
            text-align: left;
            color: white;
            line-height: var(--tight-line);
        }

        th {
            background-color: red;
            color: black;
            font-weight: normal;
            font-size: inherit;
        }

        /* Alternating row borders */
        tr:nth-child(even) td, tr:nth-child(even) th {
            border-bottom-color: white;
        }
        tr:nth-child(odd) td, tr:nth-child(odd) th {
            border-bottom-color: red;
        }
        table tr:last-child td, table tr:last-child th {
            border-bottom-color: red;
        }

        /* --- Blockquotes --- */
        blockquote {
            border-left: var(--line-thick) solid red;
            padding-left: 15px;
            margin: var(--slim-v-mar) 0;
            font-style: italic;
            color: white;
            font-size: var(--font-size0);
            line-height: var(--tight-line);
            text-indent: var(--para-inden);
        }

        /* --- Images and All Other Content --- */
        img,
        video:not([src*="youtube.com"]):not([src*="vimeo.com"]),
        audio,
        figure,
        iframe {
            border: var(--line-thick) solid red;
            display: block;
            margin: var(--slim-v-mar) auto;
            max-width: 100%;
            height: auto;
            box-sizing: border-box;
            padding: var(--min-gap);
        }

        iframe {
            border: calc(2 * var(--line-thick)) double red;
        }

        /* --- Horizontal Rule (hr) --- */
        hr {
            border: none;
            border-top: var(--line-thick) solid red;
            margin: var(--hr-v-margi) 0;
        }

        /* --- Form Elements --- */
        input, textarea, select, button {
            background-color: black;
            color: red;
            border: var(--line-thick) solid white;
            padding: 5px;
            font-family: monospace;
            font-size: var(--font-size0);
            box-sizing: border-box;
            line-height: var(--tight-line);
            margin: var(--slim-v-mar) 0;
            display: block;
        }

        input:focus, textarea:focus, select:focus, button:focus {
            border-color: red;
            outline: none;
        }

        input[type="checkbox"], input[type="radio"] {
            appearance: none;
            width: var(--font-size0);
            height: var(--font-size0);
            border: var(--line-thick) solid white;
            vertical-align: middle;
            margin-right: 5px;
            cursor: pointer;
            display: inline-block;
        }

        input[type="checkbox"]:checked, input[type="radio"]:checked {
            background-color: red;
        }

        /* --- Details/Summary --- */
        details {
            margin: var(--slim-v-mar) 0;
            border: var(--line-thick) solid black;
            box-sizing: border-box;
            font-size: var(--font-size0);
            line-height: var(--tight-line);
            color: white;
        }

        summary {
            background-color: red;
            color: black;
            padding: 5px 10px;
            cursor: pointer;
            font-size: inherit;
            font-weight: bold;
            display: block;
            position: relative;
            line-height: var(--tight-line);
            list-style: none;
        }
        summary::-webkit-details-marker {
            color: black;
            font-size: var(--font-size0);
            margin-right: var(--min-gap);
        }
        summary::marker {
            color: black;
            font-size: var(--font-size0);
            margin-right: var(--min-gap);
        }

        details[open] {
            border: var(--line-thick) solid red;
            padding: var(--min-gap);
        }
        details[open] > *:not(summary) {
            margin: var(--slim-v-mar) 0;
        }

        /* --- Selection Styling --- */
        ::selection {
            background-color: red;
            color: black;
        }

        /* ========================================= */
        /* PAGE SPECIFIC OVERRIDES         */
        /* ========================================= */
        
        body {
            text-transform: lowercase;
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
            overflow: hidden; /* Prevent double scrollbars */
        }

        /* Header adjustment */
        h1 {
            margin: 0 0 10px 0;
            display: table; /* Shrink to fit content */
        }

        /* Main Layout Container */
        .workspace {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            gap: 10px;
            overflow-y: auto; /* Scroll content if needed */
            padding-bottom: 20px;
        }

        /* Text Areas */
        .text-group {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        textarea {
            flex-grow: 1;
            resize: none; /* Let flexbox handle sizing */
            width: 100%;
            min-height: 150px;
            font-family: monospace;
        }

        /* Controls Bar */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            border: 1px solid white;
            align-items: center;
            margin: 5px 0;
        }

        .controls input[type="password"] {
            flex-grow: 1;
            margin: 0;
            min-width: 150px;
        }

        .controls button {
            margin: 0;
            flex-grow: 0;
            cursor: pointer;
            font-weight: bold;
        }

        /* Specific Action Colors (TRTB Style: Colored Borders/Text) */
        #btn-encrypt { border-color: red; color: red; }
        #btn-encrypt:hover { background-color: red; color: black; }

        #btn-load { border-color: #4488ff; color: #4488ff; }
        #btn-load:hover { background-color: #4488ff; color: black; }

        #btn-export { border-color: #00ff00; color: #00ff00; }
        #btn-export:hover { background-color: #00ff00; color: black; }

        /* Footer */
        footer {
            margin-top: auto;
            text-align: center;
            font-size: 0.8rem;
            opacity: 0.7;
            flex-shrink: 0;
        }

        /* Labels */
        .label {
            font-size: 0.8rem;
            color: red;
            margin-bottom: 5px;
            font-weight: bold;
        }

    </style>
</head>
<body>

    <h1>encry-offline.html</h1>

    <div class="workspace">
        
        <!-- Input Section -->
        <div class="text-group">
            <div class="label">working text (unencrypted)</div>
            <textarea id="input-text" placeholder="type your plain text here..."></textarea>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button id="btn-load" onclick="decryptToWorkArea()">load &uarr;</button>
            <input type="password" id="password" placeholder="secret password" value="default">
            <button id="btn-encrypt" onclick="generateEncryption()">encrypt &darr;</button>
            <button id="btn-export" onclick="exportEncrypted()">export</button>
        </div>

        <!-- Output Section -->
        <div class="text-group">
            <div class="label">encrypted output</div>
            <textarea id="output-text" placeholder="encrypted code will appear here..."></textarea>
        </div>

        <footer>
            trtb script // (c) thor smith 2025
        </footer>
    </div>

    <script>
        // --- EXPORT FUNCTIONALITY ---
        function exportEncrypted() {
            const output = document.getElementById("output-text");
            
            if (!output.value) {
                alert("no encrypted text to export yet.");
                return;
            }

            output.select();
            output.setSelectionRange(0, 99999); // For mobile devices
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(output.value).then(() => {
                    // Visual feedback using trtb colors
                    const originalBg = output.style.backgroundColor;
                    const originalColor = output.style.color;
                    
                    output.style.backgroundColor = "#00ff00";
                    output.style.color = "black";
                    
                    setTimeout(() => { 
                        output.style.backgroundColor = ""; 
                        output.style.color = ""; 
                    }, 200);
                });
            } else {
                document.execCommand('copy');
                alert("copied to clipboard!");
            }
        }

        // --- CRYPTO UTILITIES ---
        const enc = new TextEncoder();
        const dec = new TextDecoder();
        const buff_to_base64 = (buff) => btoa(String.fromCharCode.apply(null, new Uint8Array(buff)));
        const base64_to_buff = (b64) => {
            const binary_string = atob(b64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binary_string.charCodeAt(i);
            return bytes;
        };

        async function getKeyMaterial(password) {
            return window.crypto.subtle.importKey(
                "raw", 
                enc.encode(password), 
                {name: "PBKDF2"}, 
                false, 
                ["deriveKey"]
            );
        }

        async function getKey(keyMaterial, salt) {
            return window.crypto.subtle.deriveKey(
                {
                    "name": "PBKDF2",
                    salt: salt,
                    "iterations": 100000,
                    "hash": "SHA-256"
                },
                keyMaterial,
                { "name": "AES-GCM", "length": 256},
                true,
                [ "encrypt", "decrypt" ]
            );
        }

        // --- MAIN LOGIC ---
        async function generateEncryption() {
            const inputVal = document.getElementById("input-text").value;
            const password = document.getElementById("password").value;
            const outputField = document.getElementById("output-text");

            if (!inputVal) return;
            if (!password) { alert("please enter a password."); return; }

            try {
                // 1. Generate Salt and IV
                const salt = window.crypto.getRandomValues(new Uint8Array(16));
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                
                // 2. Derive Key
                const keyMaterial = await getKeyMaterial(password);
                const key = await getKey(keyMaterial, salt);

                // 3. Encrypt
                const encoded = enc.encode(inputVal);
                const encrypted = await window.crypto.subtle.encrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    encoded
                );

                // 4. Pack Salt + IV + Ciphertext into one buffer
                const combined = new Uint8Array(salt.byteLength + iv.byteLength + encrypted.byteLength);
                combined.set(salt, 0);
                combined.set(iv, salt.byteLength);
                combined.set(new Uint8Array(encrypted), salt.byteLength + iv.byteLength);

                // 5. Output to Bottom Field
                outputField.value = buff_to_base64(combined);

            } catch (e) {
                console.error(e);
                alert("error during encryption.");
            }
        }

        async function decryptToWorkArea() {
            const outputVal = document.getElementById("output-text").value;
            const password = document.getElementById("password").value;
            const workField = document.getElementById("input-text");

            if (!outputVal) return;
            if (!password) { alert("please enter a password."); return; }

            try {
                // 1. Decode Base64
                const data = base64_to_buff(outputVal);

                // 2. Extract Salt (16 bytes), IV (12 bytes), and Ciphertext
                if (data.length < 28) throw new Error("Invalid data length");
                const salt = data.slice(0, 16);
                const iv = data.slice(16, 28);
                const ciphertext = data.slice(28);

                // 3. Derive Key (using extracted salt)
                const keyMaterial = await getKeyMaterial(password);
                const key = await getKey(keyMaterial, salt);

                // 4. Decrypt
                const decrypted = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    ciphertext
                );

                // 5. Success - Update Top Field
                workField.value = dec.decode(decrypted);

            } catch (e) {
                console.error(e);
                alert("decryption failed: wrong password or corrupted data.");
            }
        }
    </script>
</body>
</html>
