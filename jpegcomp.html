<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>quickcompress</title>
    
    <link rel="stylesheet" href="trtb.css">

    <style>
        /* Utility class required for the JavaScript toggling */
        .hidden {
            display: none !important;
        }

        /* Minimal overrides to make the range slider match the trtb theme 
           (Black track, Red thumb) */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            border: none; /* Remove default input border from trtb.css for slider */
            padding: 0;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            background: red;
            border: 1px solid white;
            cursor: pointer;
            margin-top: -8px; 
        }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: white;
        }

        /* Lowercase enforcement */
        body {
            text-transform: lowercase;
        }
    </style>
</head>
<body>

    <h1>quickcompress</h1>
    <p>mode: jpeg output</p>
    <hr>

    <main>

        <div id="upload-area">
            <p>select or drop an image to begin.</p>
            <p class="em" style="font-size: 0.8em;">(supports: png, jpg, webp, heic)</p>
            <input id="file-input" type="file" accept="image/*">
        </div>

        <div id="editor-area" class="hidden">
            
            <figure>
                <img id="preview-image" alt="preview">
                <figcaption>preview render</figcaption>
            </figure>

            <h3>statistics</h3>
            <table>
                <thead>
                    <tr>
                        <th>metric</th>
                        <th>value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>original size</td>
                        <td id="original-size">-</td>
                    </tr>
                    <tr>
                        <td>compressed size</td>
                        <td id="compressed-size">-</td>
                    </tr>
                </tbody>
            </table>

            <hr>

            <h3>settings</h3>
            <p>
                compression level: <span id="quality-value" class="em">80%</span>
            </p>
            <div style="border: 1px solid white; padding: 10px;">
                <input id="quality-slider" type="range" min="0.01" max="1" step="0.01" value="0.8">
                <div style="display: flex; justify-content: space-between; font-size: 0.8em;">
                    <span>low quality</span>
                    <span>high quality</span>
                </div>
            </div>

            <br>

            <button id="download-btn">download image</button>
            <button id="reset-btn" style="background-color: #111; border-color: #555;">start over</button>

        </div>

    </main>

    <script>
        // Elements
        const fileInput = document.getElementById('file-input');
        const uploadArea = document.getElementById('upload-area');
        const editorArea = document.getElementById('editor-area');
        const previewImage = document.getElementById('preview-image');
        const originalSizeDisplay = document.getElementById('original-size');
        const compressedSizeDisplay = document.getElementById('compressed-size');
        const qualitySlider = document.getElementById('quality-slider');
        const qualityValue = document.getElementById('quality-value');
        const downloadBtn = document.getElementById('download-btn');
        const resetBtn = document.getElementById('reset-btn');

        // State
        let originalFile = null;
        let originalImage = new Image();
        let compressedBlob = null;

        // Event Listeners
        fileInput.addEventListener('change', handleFileSelect);
        qualitySlider.addEventListener('input', handleSliderInput);
        qualitySlider.addEventListener('change', compressImage); // Commit change on release
        downloadBtn.addEventListener('click', downloadImage);
        resetBtn.addEventListener('click', resetApp);

        // Setup drag and drop visuals
        // Note: trtb.css doesn't use dashed lines, so we rely on standard browser drag behavior
        // attached to the div wrapper.
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                if (!file.type.startsWith('image/')) {
                    alert('please upload an image file.');
                    return;
                }
                originalFile = file;
                loadFile(file);
            }
        }

        function loadFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                originalImage.src = e.target.result;
                originalImage.onload = () => {
                    // Initial setup
                    originalSizeDisplay.textContent = formatBytes(file.size);
                    
                    // Show editor, hide upload
                    uploadArea.classList.add('hidden');
                    editorArea.classList.remove('hidden');
                    
                    // Initial compress
                    compressImage();
                };
            };
            reader.readAsDataURL(file);
        }

        // Update the % text while dragging
        function handleSliderInput(e) {
            const val = Math.round(e.target.value * 100);
            qualityValue.textContent = `${val}%`;
        }

        function compressImage() {
            const quality = parseFloat(qualitySlider.value);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Use original dimensions
            canvas.width = originalImage.naturalWidth;
            canvas.height = originalImage.naturalHeight;

            // Draw image to canvas
            // White background to handle transparency in PNGs converting to JPEG
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);

            // Compress to JPEG
            canvas.toBlob((blob) => {
                compressedBlob = blob;
                
                // Update UI
                const url = URL.createObjectURL(blob);
                previewImage.onload = () => {
                    // Clean up memory logic would go here
                };
                previewImage.src = url;
                
                compressedSizeDisplay.textContent = formatBytes(blob.size);

                // Visual feedback on size reduction using trtb.css classes
                // If compressed is LARGER than original, add 'em' (red text)
                if (blob.size >= originalFile.size) {
                    compressedSizeDisplay.classList.add('em');
                } else {
                    compressedSizeDisplay.classList.remove('em');
                }

            }, 'image/jpeg', quality);
        }

        function downloadImage() {
            if (!compressedBlob) return;
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(compressedBlob);
            
            // Generate filename: original_compressed.jpg
            const originalName = originalFile.name.split('.')[0];
            link.download = `${originalName}_compressed.jpg`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function resetApp() {
            fileInput.value = '';
            originalFile = null;
            compressedBlob = null;
            originalImage = new Image();
            
            editorArea.classList.add('hidden');
            uploadArea.classList.remove('hidden');
            
            // Reset slider
            qualitySlider.value = 0.8;
            qualityValue.textContent = '80%';
        }

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['bytes', 'kb', 'mb', 'gb'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
