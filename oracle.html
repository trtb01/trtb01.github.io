<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>the oracle</title>
    <link rel="stylesheet" href="trtb.css">
    <style>
        /* --- Page Specific Overrides --- */
        
        body {
            text-transform: lowercase;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            /* Override body padding for mobile alignment */
            padding-top: 2rem; 
        }

        /* Center the header like in about.html */
        h1 {
            display: table;
            margin: 0 auto 2rem auto;
        }

        /* Game Container */
        .game-container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Display Box - Custom styling to fit theme but look like a screen */
        .display-box {
            border: 1px solid white;
            padding: 2rem 1rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .result-main {
            font-size: 5rem;
            font-weight: bold;
            color: red; /* trtb accent */
            line-height: 1;
            margin: 0.5rem 0;
        }

        .result-sub {
            font-size: 2rem;
            color: white;
            opacity: 0.9;
        }

        .label {
            font-size: 0.8rem;
            color: #888; /* dim grey for labels */
            margin-bottom: 0;
        }

        /* Roll Button - Make it stand out */
        button.roll-btn {
            width: 100%;
            font-size: 1.5rem;
            padding: 15px;
            border-color: red;
            color: red;
            font-weight: bold;
            cursor: pointer;
            margin-top: 0;
        }
        
        button.roll-btn:active {
            background-color: red;
            color: black;
        }

        /* Settings Group */
        .settings-group {
            display: flex;
            justify-content: space-between;
            border: 1px solid white;
            padding: 10px;
            margin-top: 1rem;
        }

        .setting-item {
            display: flex;
            align-items: center;
        }
        
        /* Override margins for inputs inside the flex container */
        .setting-item input {
            margin: 0 10px 0 0; 
        }

        /* Table specific tweaks for inside details */
        .rule-table td {
            border: 1px solid red; /* Ensure borders match trtb table style */
        }

    </style>
</head>
<body>

    <div class="game-container">
        <h1>the oracle</h1>

        <!-- Main Display -->
        <div class="display-box">
            <div>
                <p class="label">outcome (d100)</p>
                <div id="d100-display" class="result-main">--</div>
            </div>
            <hr style="border-color: #333; margin: 1.5rem 0;">
            <div>
                <p class="label">nuance (d10)</p>
                <div id="modifier-display" class="result-sub">--</div>
            </div>
        </div>

        <!-- Main Action -->
        <button class="roll-btn" onclick="rollDice()">roll</button>

        <!-- Settings (Using Checkboxes for trtb styling) -->
        <div class="settings-group">
            <label class="setting-item">
                <input type="checkbox" id="shake-toggle" onchange="toggleShake()">
                shake to roll
            </label>
            <label class="setting-item">
                <input type="checkbox" id="tts-toggle" onchange="toggleTTS()">
                voice
            </label>
        </div>

        <!-- Instructions via Details/Summary -->
        <details>
            <summary>how to play</summary>
            <p><strong>1. outcome (d100)</strong></p>
            <p>compare the big red number to your target number.</p>
            <ul>
                <li>≤ target: success</li>
                <li>> target: failure</li>
            </ul>

            <hr>

            <p><strong>2. nuance (±d10)</strong></p>
            <p>check the smaller white number.</p>
            
            <table class="rule-table">
                <tbody>
                    <tr>
                        <td class="em">±8 or higher</td>
                        <td>...and<br>(bonus / shortfall)</td>
                    </tr>
                    <tr>
                        <td>±3 to ±7</td>
                        <td>standard</td>
                    </tr>
                    <tr>
                        <td class="em">below ±3</td>
                        <td>...but<br>(complication / silver lining)</td>
                    </tr>
                </tbody>
            </table>
        </details>
    </div>

    <script>
        // State
        let useShake = false;
        let useTTS = false;
        let shakeThreshold = 15;
        let lastX, lastY, lastZ;
        let lastUpdate = 0;
        let shakeCooldown = false;

        // DOM Elements
        const d100El = document.getElementById('d100-display');
        const modEl = document.getElementById('modifier-display');

        // Core Game Logic
        function rollDice() {
            // 1. d100 (1-100)
            const d100 = Math.floor(Math.random() * 100) + 1;
            
            // 2. d10 (1-10)
            const d10 = Math.floor(Math.random() * 10) + 1;
            
            // 3. Coin (Positive or Negative)
            const isHeads = Math.random() > 0.5;
            const modifier = isHeads ? d10 : -d10;

            // Update UI
            d100El.innerText = d100;
            modEl.innerText = modifier > 0 ? "+" + modifier : modifier;

            // Handle Voice
            if (useTTS) {
                speakResults(d100, modifier);
            }
        }

        // Text to Speech Logic
        function speakResults(d100, modifier) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // Stop previous speech

                let modText = "";
                if (modifier < 0) {
                    modText = "minus " + Math.abs(modifier);
                } else {
                    modText = Math.abs(modifier).toString();
                }

                // Create utterance: "75, minus 6"
                const text = `${d100}, ${modText}`;
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Try to find a decent voice
                utterance.rate = 1.1;
                utterance.pitch = 1;
                
                window.speechSynthesis.speak(utterance);
            }
        }

        // Shake Logic
        function toggleShake() {
            const checkbox = document.getElementById('shake-toggle');
            useShake = checkbox.checked;

            if (useShake) {
                requestMotionPermission();
                window.addEventListener('devicemotion', handleMotion, false);
            } else {
                window.removeEventListener('devicemotion', handleMotion, false);
            }
        }

        function toggleTTS() {
            const checkbox = document.getElementById('tts-toggle');
            useTTS = checkbox.checked;
        }

        function requestMotionPermission() {
            // iOS 13+ requirement
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response !== 'granted') {
                            alert('shake permission denied');
                            document.getElementById('shake-toggle').checked = false;
                            toggleShake(); // Turn it back off
                        }
                    })
                    .catch(console.error);
            }
        }

        function handleMotion(event) {
            if (!useShake || shakeCooldown) return;

            const current = event.accelerationIncludingGravity;
            if (!current) return;

            const curTime = new Date().getTime();

            if ((curTime - lastUpdate) > 100) {
                const diffTime = curTime - lastUpdate;
                lastUpdate = curTime;

                if (!lastX) {
                    lastX = current.x;
                    lastY = current.y;
                    lastZ = current.z;
                    return;
                }

                const deltaX = current.x - lastX;
                const deltaY = current.y - lastY;
                const deltaZ = current.z - lastZ;

                const speed = Math.abs(deltaX + deltaY + deltaZ) / diffTime * 10000;

                if (speed > shakeThreshold * 100) {
                    rollDice();
                    shakeCooldown = true;
                    setTimeout(() => { shakeCooldown = false; }, 1000); // 1 second cooldown
                }

                lastX = current.x;
                lastY = current.y;
                lastZ = current.z;
            }
        }
    </script>
</body>
</html>
